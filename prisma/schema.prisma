// =============================================================================
// C4DENCE ‚Äî Schema Prisma
// =============================================================================
// Application de gestion d'ex√©cution strat√©gique bas√©e sur la m√©thodologie 4DX
// (The 4 Disciplines of Execution)
//
// Version : 1.0
// Date    : 30 novembre 2025
// Auteur  : Boulet Strat√©gies TI
// =============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
  // fullTextSearchPostgres : Recherche texte PostgreSQL native (renomm√© en Prisma 7)
}

datasource db {
  provider = "postgresql"
  schemas  = ["c4dence"]
  // Prisma 7: URLs configur√©es dans prisma.config.ts
  // Le schema 'c4dence' isole les tables de l'app CRM existante.
}

// =============================================================================
// √âNUM√âRATIONS
// =============================================================================

/// Statut calcul√© d'un WIG bas√© sur la progression vs la cible
/// R√®gle de calcul (voir lib/wig-status.ts) :
/// - ON_TRACK  : progression >= 90% de la cible attendue √† cette date
/// - AT_RISK   : progression entre 70% et 90%
/// - OFF_TRACK : progression < 70%
enum WigStatus {
  ON_TRACK   // üü¢ En bonne voie
  AT_RISK    // üü° √Ä risque
  OFF_TRACK  // üî¥ Hors piste
  ACHIEVED   // üèÜ Objectif atteint

  @@schema("c4dence")
}

/// Statut d'un obstacle/blocker signal√©
enum BlockerStatus {
  OPEN       // üî¥ Ouvert ‚Äî obstacle actif
  ESCALATED  // üü° Escalad√© ‚Äî remont√© √† un sup√©rieur
  RESOLVED   // üü¢ R√©solu ‚Äî obstacle lev√©

  @@schema("c4dence")
}

/// R√¥le d'un membre dans une organisation
/// D√©termine les permissions dans l'application
enum MemberRole {
  OWNER   // Propri√©taire : tous les droits, facturation, suppression org
  ADMIN   // Admin : gestion des membres, tous les WIGs
  MEMBER  // Membre : lecture/√©criture sur WIGs assign√©s uniquement

  @@schema("c4dence")
}

/// Statut d'un engagement pris lors d'une r√©union de cadence
enum EngagementStatus {
  PENDING    // ‚è≥ En attente ‚Äî engagement pris, pas encore r√©alis√©
  COMPLETED  // ‚úÖ Compl√©t√© ‚Äî engagement r√©alis√© dans les d√©lais
  MISSED     // ‚ùå Manqu√© ‚Äî engagement non r√©alis√© √† la date pr√©vue
  CANCELLED  // üö´ Annul√© ‚Äî engagement annul√© (changement de priorit√©)

  @@schema("c4dence")
}

/// Jour de la semaine pour la r√©union de cadence
enum CadenceDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY

  @@schema("c4dence")
}

// =============================================================================
// MOD√àLES PRINCIPAUX
// =============================================================================

/// Profile utilisateur ‚Äî Li√© √† Supabase Auth (auth.users)
/// 
/// IMPORTANT : Ce mod√®le est synchronis√© avec Supabase Auth via un trigger.
/// Le trigger `on_auth_user_created` dans Supabase cr√©e automatiquement
/// un Profile quand un utilisateur s'inscrit.
/// 
/// Ne JAMAIS cr√©er de Profile manuellement ‚Äî utiliser Supabase Auth.
model Profile {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Champs synchronis√©s depuis Supabase Auth ---
  email     String   @unique
  fullName  String?  @map("full_name")
  avatarUrl String?  @map("avatar_url")

  // --- Pr√©f√©rences utilisateur ---
  timezone  String   @default("America/Toronto")
  locale    String   @default("fr-CA")

  // --- Relations ---
  memberships    Membership[]   // Organisations dont l'utilisateur est membre
  engagements    Engagement[]   // Engagements pris par l'utilisateur
  ownedWigs      Wig[]          @relation("WigOwner") // WIGs dont l'utilisateur est responsable
  assignedMeasures LeadMeasure[] @relation("MeasureAssignee") // Mesures assign√©es
  reportedBlockers Blocker[]    @relation("BlockerReporter") // Obstacles signal√©s

  @@schema("c4dence")
  @@map("profiles")
}

/// Organisation ‚Äî Entit√© principale de regroupement
/// 
/// Repr√©sente une entreprise, une √©quipe, ou un d√©partement.
/// Tous les WIGs appartiennent √† une organisation.
/// Multi-tenant : les donn√©es sont isol√©es par organisation via RLS.
/// 
/// Exemples :
/// - "FLB Solutions Alimentaires"
/// - "√âquipe Marketing ‚Äî Bergeron"
/// - "Division Est ‚Äî Distribution XYZ"
model Organization {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Identification ---
  name      String                        // Nom affich√© : "FLB Solutions Alimentaires"
  slug      String   @unique              // URL-friendly : "flb-solutions"
  
  // --- Param√®tres de cadence (Discipline 4) ---
  cadenceDay  CadenceDay @default(MONDAY) @map("cadence_day")  // Jour de la r√©union hebdo
  cadenceTime String     @default("09:00") @map("cadence_time") // Heure (format HH:mm)

  // --- Branding (optionnel) ---
  logoUrl   String?  @map("logo_url")

  // --- Activation (Super Admin) ---
  isActive  Boolean  @default(true) @map("is_active")

  // --- Relations ---
  memberships Membership[]
  wigs        Wig[]
  invitations Invitation[]

  @@schema("c4dence")
  @@map("organizations")
}

/// Membership ‚Äî Relation many-to-many entre Profile et Organization
/// 
/// Un utilisateur peut √™tre membre de plusieurs organisations.
/// Le r√¥le d√©termine les permissions :
/// - OWNER  : 1 seul par org, g√®re facturation et suppression
/// - ADMIN  : G√®re membres et tous les WIGs
/// - MEMBER : Acc√®s lecture/√©criture aux WIGs assign√©s
model Membership {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")

  // --- Relations ---
  profileId      String       @map("profile_id")
  profile        Profile      @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // --- R√¥le dans l'organisation ---
  role           MemberRole   @default(MEMBER)

  // Un utilisateur ne peut √™tre membre qu'une fois par organisation
  @@unique([profileId, organizationId])
  @@index([profileId])
  @@index([organizationId])
  @@schema("c4dence")
  @@map("memberships")
}

// =============================================================================
// MOD√àLES 4DX
// =============================================================================

/// WIG ‚Äî Wildly Important Goal (Objectif Absolument Prioritaire)
/// 
/// Discipline 1 : Se concentrer sur l'essentiel
/// Un WIG est un objectif strat√©gique mesurable avec une √©ch√©ance.
/// 
/// Format recommand√© : "De X √† Y d'ici [date]"
/// Exemples :
/// - "Augmenter le CA de 2.5M$ √† 3.2M$ d'ici le 31 d√©cembre 2025"
/// - "R√©duire le taux de retour de 8% √† 3% d'ici le 30 juin 2025"
/// - "Atteindre 150 clients actifs (actuellement 89) d'ici le 31 mars 2025"
/// 
/// R√®gles 4DX :
/// - Maximum 2-3 WIGs actifs par √©quipe
/// - Doit √™tre mesurable objectivement
/// - L'√©ch√©ance cr√©e l'urgence
model Wig {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Relation organisation ---
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // --- Responsable du WIG (4DX: accountability) ---
  // Note: Optionnel pour compatibilit√© avec WIGs existants, mais requis √† la cr√©ation
  ownerId        String?      @map("owner_id")
  owner          Profile?     @relation("WigOwner", fields: [ownerId], references: [id])

  // --- D√©finition du WIG ---
  name           String       // Nom court : "Croissance CA 2025"
  description    String?      // Description compl√®te avec contexte
  
  // --- M√©triques (Lag Measure / Mesure de r√©sultat) ---
  // La mesure de r√©sultat = ce qu'on veut atteindre
  // Exemple : Chiffre d'affaires, Taux de satisfaction, Nombre de clients
  startValue     Float        @map("start_value")   // Valeur de d√©part : 2500000
  targetValue    Float        @map("target_value")  // Valeur cible : 3200000
  currentValue   Float        @default(0) @map("current_value") // Valeur actuelle : 2750000
  unit           String       @default("")          // Unit√© : "$", "%", "clients"

  // --- P√©riode ---
  startDate      DateTime     @map("start_date")    // Date de d√©but du WIG
  endDate        DateTime     @map("end_date")      // Date d'√©ch√©ance

  // --- Statut ---
  // IMPORTANT : Ce champ est d√©normalis√© pour performance.
  // Il est recalcul√© par un job CRON ou lors de la mise √† jour des mesures.
  // Voir lib/wig-status.ts pour l'algorithme de calcul.
  status         WigStatus    @default(AT_RISK)

  // --- Archivage ---
  isArchived     Boolean      @default(false) @map("is_archived")
  archivedAt     DateTime?    @map("archived_at")

  // --- Relations ---
  leadMeasures   LeadMeasure[]
  blockers       Blocker[]

  @@index([organizationId])
  @@index([ownerId])
  @@index([status])
  @@index([isArchived])
  @@schema("c4dence")
  @@map("wigs")
}

/// LeadMeasure ‚Äî Mesure Pr√©dictive
/// 
/// Discipline 2 : Agir sur les mesures pr√©dictives
/// Une mesure pr√©dictive est une action INFLUEN√áABLE et PR√âDICTIVE du r√©sultat.
/// 
/// Caract√©ristiques :
/// - INFLUEN√áABLE : L'√©quipe peut agir directement dessus
/// - PR√âDICTIVE : Corr√©l√©e avec l'atteinte du WIG
/// 
/// Exemples pour WIG "Augmenter CA de 2.5M$ √† 3.2M$" :
/// - "Nombre d'appels de prospection par semaine" (cible: 50)
/// - "Nombre de d√©mos produit par semaine" (cible: 10)
/// - "Nombre de propositions envoy√©es par semaine" (cible: 5)
/// 
/// Anti-exemples (NON pr√©dictifs) :
/// - "Nombre de ventes" (c'est le r√©sultat, pas l'action)
/// - "CA g√©n√©r√©" (c'est le WIG lui-m√™me)
/// 
/// R√®gles 4DX :
/// - Maximum 2-3 mesures pr√©dictives par WIG
/// - Doit √™tre mesurable chaque semaine
/// - L'√©quipe doit pouvoir influencer directement
model LeadMeasure {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Relation WIG ---
  wigId     String   @map("wig_id")
  wig       Wig      @relation(fields: [wigId], references: [id], onDelete: Cascade)

  // --- Responsable de la mesure (4DX: accountability) ---
  assignedToId   String?      @map("assigned_to_id")
  assignedTo     Profile?     @relation("MeasureAssignee", fields: [assignedToId], references: [id])

  // --- D√©finition ---
  name           String       // "Appels de prospection"
  description    String?      // "Appels sortants vers prospects qualifi√©s"
  
  // --- Cible hebdomadaire ---
  // La cible repr√©sente l'objectif HEBDOMADAIRE √† atteindre
  targetPerWeek  Float        @map("target_per_week")  // Cible : 50 appels/semaine
  unit           String       @default("")             // Unit√© : "appels", "d√©mos", "$"

  // --- Ordre d'affichage ---
  sortOrder      Int          @default(0) @map("sort_order")

  // --- Relations ---
  weeklyMeasures WeeklyMeasure[]
  engagements    Engagement[]   @relation("EngagementMeasure")

  @@index([wigId])
  @@index([assignedToId])
  @@schema("c4dence")
  @@map("lead_measures")
}

/// WeeklyMeasure ‚Äî Mesure hebdomadaire d'une LeadMeasure
/// 
/// Discipline 3 : Tenir un tableau de r√©sultats convaincant
/// Chaque semaine, l'√©quipe enregistre sa performance sur chaque mesure pr√©dictive.
/// 
/// Le num√©ro de semaine suit la norme ISO 8601 :
/// - Semaine 1 = premi√®re semaine contenant un jeudi
/// - Une ann√©e peut avoir 52 ou 53 semaines
/// 
/// Exemple :
/// - LeadMeasure: "Appels de prospection" (cible: 50/semaine)
/// - Semaine 48, 2025 : value = 47 (94% de la cible)
/// - Semaine 49, 2025 : value = 52 (104% de la cible)
model WeeklyMeasure {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Relation LeadMeasure ---
  leadMeasureId String      @map("lead_measure_id")
  leadMeasure   LeadMeasure @relation(fields: [leadMeasureId], references: [id], onDelete: Cascade)

  // --- P√©riode (ISO 8601) ---
  year          Int         // Ann√©e : 2025
  weekNumber    Int         @map("week_number") // Semaine ISO : 1-53

  // --- Valeur enregistr√©e ---
  value         Float       // Valeur r√©elle : 47 (appels effectu√©s)
  
  // --- Notes optionnelles ---
  // Permet de contextualiser une semaine exceptionnelle
  // Ex: "Semaine courte ‚Äî 2 jours f√©ri√©s"
  notes         String?

  // Une seule mesure par semaine par LeadMeasure
  @@unique([leadMeasureId, year, weekNumber])
  @@index([leadMeasureId])
  @@index([year, weekNumber])
  @@schema("c4dence")
  @@map("weekly_measures")
}

/// Invitation ‚Äî Invitation en attente pour rejoindre une organisation
///
/// Permet d'inviter des utilisateurs par email avant qu'ils ne s'inscrivent.
/// L'invitation expire apr√®s 7 jours et contient un token unique.
model Invitation {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")

  // --- Organisation cible ---
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // --- D√©tails invitation ---
  email     String       // Email de la personne invit√©e
  role      MemberRole   @default(MEMBER) // R√¥le qui sera attribu√©
  token     String       @unique // Token unique pour le lien
  expiresAt DateTime     @map("expires_at") // Date d'expiration
  acceptedAt DateTime?   @map("accepted_at") // Null si pas encore accept√©e

  @@index([organizationId])
  @@index([email])
  @@schema("c4dence")
  @@map("invitations")
}

/// Engagement ‚Äî Engagement pris lors d'une r√©union de cadence
/// 
/// Discipline 4 : Cr√©er une cadence de responsabilisation
/// Lors de la r√©union hebdomadaire, chaque membre prend 1-2 engagements
/// sp√©cifiques pour la semaine √† venir.
/// 
/// Format recommand√© : Verbe d'action + Objet + D√©lai
/// Exemples :
/// - "Appeler les 10 prospects chauds de la liste avant mercredi"
/// - "Finaliser la proposition ABC Corp avant vendredi 17h"
/// - "Relancer les 3 devis en attente"
/// 
/// R√®gles 4DX :
/// - 1-2 engagements par personne par semaine (pas plus!)
/// - Doit √™tre compl√©table en 1 semaine
/// - Li√© aux mesures pr√©dictives (actions qui font avancer le score)
/// 
/// Lors de la r√©union suivante :
/// 1. Chacun rapporte sur ses engagements de la semaine pass√©e
/// 2. Statut : COMPLETED, MISSED, ou explication
/// 3. Nouveaux engagements pour la semaine √† venir
model Engagement {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Qui s'engage ---
  profileId String   @map("profile_id")
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // --- Pour quelle organisation (contexte multi-tenant) ---
  // Note: On pourrait d√©duire via profile->membership->organization,
  // mais on d√©normalise pour simplifier les queries et RLS
  organizationId String @map("organization_id")

  // --- P√©riode ---
  year       Int      // Ann√©e : 2025
  weekNumber Int      @map("week_number") // Semaine ISO : 48

  // --- Contenu de l'engagement ---
  description String  // "Appeler les 10 prospects chauds avant mercredi"

  // --- Lien optionnel vers une Lead Measure (4DX: impact sur le score) ---
  leadMeasureId String?      @map("lead_measure_id")
  leadMeasure   LeadMeasure? @relation("EngagementMeasure", fields: [leadMeasureId], references: [id])

  // --- Suivi ---
  status      EngagementStatus @default(PENDING)
  completedAt DateTime?        @map("completed_at") // Quand marqu√© COMPLETED
  
  // --- Notes de suivi ---
  // Rempli lors de la r√©union suivante pour expliquer le r√©sultat
  // Ex: "8/10 appel√©s, 2 injoignables ‚Äî replanifi√© semaine prochaine"
  followUpNotes String?        @map("follow_up_notes")

  @@index([profileId])
  @@index([organizationId])
  @@index([year, weekNumber])
  @@index([status])
  @@index([leadMeasureId])
  @@schema("c4dence")
  @@map("engagements")
}

/// Blocker ‚Äî Obstacle signal√© lors d'une r√©union de cadence
///
/// Discipline 4 : Phase "Clear" de la WIG Session
/// Les obstacles sont des probl√®mes qui bloquent l'avancement d'un WIG
/// et qui n√©cessitent une action ou une escalade.
///
/// Exemples :
/// - "Budget marketing gel√© jusqu'√† Q2"
/// - "Ressource cl√© en cong√© maladie"
/// - "D√©pendance sur √©quipe IT bloqu√©e"
model Blocker {
  id           String        @id @default(uuid())
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // --- Quel WIG est impact√© ---
  wigId        String        @map("wig_id")
  wig          Wig           @relation(fields: [wigId], references: [id], onDelete: Cascade)

  // --- Qui a signal√© l'obstacle ---
  reportedById String        @map("reported_by_id")
  reportedBy   Profile       @relation("BlockerReporter", fields: [reportedById], references: [id])

  // --- Description de l'obstacle ---
  description  String        // "Budget marketing gel√© jusqu'√† Q2"

  // --- Suivi ---
  status       BlockerStatus @default(OPEN)
  escalatedTo  String?       @map("escalated_to") // Nom/email de la personne
  resolvedAt   DateTime?     @map("resolved_at")
  resolution   String?       // Comment l'obstacle a √©t√© r√©solu

  @@index([wigId])
  @@index([reportedById])
  @@index([status])
  @@schema("c4dence")
  @@map("blockers")
}

// =============================================================================
// VUES ET INDEXES ADDITIONNELS
// =============================================================================

// Note : Les vues PostgreSQL et index avanc√©s sont g√©r√©s via des migrations
// SQL manuelles dans prisma/migrations/

// Exemple de vue utile (√† cr√©er via migration SQL) :
// 
// CREATE VIEW wig_progress AS
// SELECT 
//   w.id as wig_id,
//   w.name,
//   w.start_value,
//   w.target_value,
//   w.current_value,
//   w.start_date,
//   w.end_date,
//   -- Progression en pourcentage
//   CASE 
//     WHEN w.target_value = w.start_value THEN 100
//     ELSE ROUND(((w.current_value - w.start_value) / (w.target_value - w.start_value)) * 100, 1)
//   END as progress_percent,
//   -- Jours √©coul√©s vs total
//   EXTRACT(DAY FROM (NOW() - w.start_date)) as days_elapsed,
//   EXTRACT(DAY FROM (w.end_date - w.start_date)) as total_days,
//   -- Progression temporelle en pourcentage
//   ROUND(EXTRACT(DAY FROM (NOW() - w.start_date)) / NULLIF(EXTRACT(DAY FROM (w.end_date - w.start_date)), 0) * 100, 1) as time_progress_percent
// FROM wigs w
// WHERE w.is_archived = false;

// =============================================================================
// NOTES D'IMPL√âMENTATION
// =============================================================================

// 1. ROW LEVEL SECURITY (RLS)
// ---------------------------
// Supabase RLS policies doivent √™tre cr√©√©es pour :
// - profiles : Lecture/√©criture uniquement son propre profil
// - organizations : Via membership
// - memberships : OWNER/ADMIN peuvent g√©rer
// - wigs, lead_measures, weekly_measures : Via organization membership
// - engagements : Lecture org, √©criture soi-m√™me
//
// Voir le fichier SQL s√©par√© : prisma/rls-policies.sql

// 2. TRIGGERS SUPABASE
// --------------------
// - on_auth_user_created : Cr√©e Profile quand user s'inscrit
// - on_profile_updated : Sync avec auth.users si n√©cessaire
//
// Voir : supabase/migrations/

// 3. CALCUL DU STATUT WIG
// -----------------------
// Le statut est recalcul√© :
// - √Ä chaque mise √† jour de WeeklyMeasure (via Server Action)
// - Via CRON job quotidien (pour rattraper les edge cases)
//
// Algorithme dans : lib/wig-status.ts

// 4. SOFT DELETE
// --------------
// Les WIGs utilisent isArchived plut√¥t que suppression.
// Les autres entit√©s utilisent CASCADE via foreign keys.
// Un WIG archiv√© reste visible en lecture seule.
