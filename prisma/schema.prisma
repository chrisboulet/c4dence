// =============================================================================
// C4DENCE ‚Äî Schema Prisma
// =============================================================================
// Application de gestion d'ex√©cution strat√©gique bas√©e sur la M√©thode C4DENCE
// (Les 4 Piliers de l'Ex√©cution Strat√©gique)
//
// Version : 2.0
// Date    : 1 d√©cembre 2025
// Auteur  : Boulet Strat√©gies TI
// =============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
  // fullTextSearchPostgres : Recherche texte PostgreSQL native (renomm√© en Prisma 7)
}

datasource db {
  provider = "postgresql"
  schemas  = ["c4dence"]
  // Prisma 7: URLs configur√©es dans prisma.config.ts
  // Le schema 'c4dence' isole les tables de l'app CRM existante.
}

// =============================================================================
// √âNUM√âRATIONS
// =============================================================================

/// Statut calcul√© d'un Objectif Prioritaire bas√© sur la progression vs la cible
/// R√®gle de calcul (voir lib/objective-status.ts) :
/// - ON_TRACK  : progression >= 90% de la cible attendue √† cette date
/// - AT_RISK   : progression entre 70% et 90%
/// - OFF_TRACK : progression < 70%
enum ObjectiveStatus {
  ON_TRACK   // üü¢ En bonne voie
  AT_RISK    // üü° √Ä risque
  OFF_TRACK  // üî¥ Hors piste
  ACHIEVED   // üèÜ Objectif atteint

  @@schema("c4dence")
}

/// Statut d'un obstacle/blocker signal√©
enum BlockerStatus {
  OPEN       // üî¥ Ouvert ‚Äî obstacle actif
  ESCALATED  // üü° Escalad√© ‚Äî remont√© √† un sup√©rieur
  RESOLVED   // üü¢ R√©solu ‚Äî obstacle lev√©

  @@schema("c4dence")
}

/// R√¥le d'un membre dans une organisation
/// D√©termine les permissions dans l'application
enum MemberRole {
  OWNER   // Propri√©taire : tous les droits, facturation, suppression org
  ADMIN   // Admin : gestion des membres, tous les Objectifs
  MEMBER  // Membre : lecture/√©criture sur Objectifs assign√©s uniquement

  @@schema("c4dence")
}

/// Statut d'un engagement pris lors d'une r√©union de synchronisation
enum EngagementStatus {
  PENDING    // ‚è≥ En attente ‚Äî engagement pris, pas encore r√©alis√©
  COMPLETED  // ‚úÖ Compl√©t√© ‚Äî engagement r√©alis√© dans les d√©lais
  MISSED     // ‚ùå Manqu√© ‚Äî engagement non r√©alis√© √† la date pr√©vue
  CANCELLED  // üö´ Annul√© ‚Äî engagement annul√© (changement de priorit√©)

  @@schema("c4dence")
}

/// Jour de la semaine pour la r√©union de synchronisation
enum SyncDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY

  @@schema("c4dence")
}

// =============================================================================
// MOD√àLES PRINCIPAUX
// =============================================================================

/// Profile utilisateur ‚Äî Li√© √† Supabase Auth (auth.users)
/// 
/// IMPORTANT : Ce mod√®le est synchronis√© avec Supabase Auth via un trigger.
/// Le trigger `on_auth_user_created` dans Supabase cr√©e automatiquement
/// un Profile quand un utilisateur s'inscrit.
/// 
/// Ne JAMAIS cr√©er de Profile manuellement ‚Äî utiliser Supabase Auth.
model Profile {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Champs synchronis√©s depuis Supabase Auth ---
  email     String   @unique
  fullName  String?  @map("full_name")
  avatarUrl String?  @map("avatar_url")

  // --- Pr√©f√©rences utilisateur ---
  timezone  String   @default("America/Toronto")
  locale    String   @default("fr-CA")

  // --- Relations ---
  memberships    Membership[]   // Organisations dont l'utilisateur est membre
  engagements    Engagement[]   // Engagements pris par l'utilisateur
  ownedObjectives Objective[]   @relation("ObjectiveOwner") // Objectifs dont l'utilisateur est responsable
  assignedMeasures LeadMeasure[] @relation("MeasureAssignee") // Indicateurs assign√©s
  reportedBlockers Blocker[]    @relation("BlockerReporter") // Obstacles signal√©s
  
  // --- C4DENCE v3.1 ---
  assignedTasks    Task[]

  @@schema("c4dence")
  @@map("profiles")
}

/// Organisation ‚Äî Entit√© principale de regroupement
///
/// Repr√©sente une entreprise, une √©quipe, ou un d√©partement.
/// Tous les Objectifs appartiennent √† une organisation.
/// Multi-tenant : les donn√©es sont isol√©es par organisation via RLS.
/// 
/// Exemples :
/// - "FLB Solutions Alimentaires"
/// - "√âquipe Marketing ‚Äî Bergeron"
/// - "Division Est ‚Äî Distribution XYZ"
model Organization {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Identification ---
  name      String                        // Nom affich√© : "FLB Solutions Alimentaires"
  slug      String   @unique              // URL-friendly : "flb-solutions"
  
  // --- Param√®tres de synchronisation (Pilier 4 : Rythme de Responsabilit√©) ---
  syncDay  SyncDay @default(MONDAY) @map("sync_day")  // Jour de la r√©union hebdo
  syncTime String  @default("09:00") @map("sync_time") // Heure (format HH:mm)

  // --- Branding (optionnel) ---
  logoUrl   String?  @map("logo_url")

  // --- Activation (Super Admin) ---
  isActive  Boolean  @default(true) @map("is_active")

  // --- Relations ---
  memberships Membership[]
  objectives  Objective[]
  invitations Invitation[]
  
  // --- C4DENCE v3.1 ---
  tasks            Task[]
  timeAllocations  TimeAllocation[]
  cadenceMode      CadenceMode?

  @@schema("c4dence")
  @@map("organizations")
}

/// Membership ‚Äî Relation many-to-many entre Profile et Organization
///
/// Un utilisateur peut √™tre membre de plusieurs organisations.
/// Le r√¥le d√©termine les permissions :
/// - OWNER  : 1 seul par org, g√®re facturation et suppression
/// - ADMIN  : G√®re membres et tous les Objectifs
/// - MEMBER : Acc√®s lecture/√©criture aux Objectifs assign√©s
model Membership {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")

  // --- Relations ---
  profileId      String       @map("profile_id")
  profile        Profile      @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // --- R√¥le dans l'organisation ---
  role           MemberRole   @default(MEMBER)

  // Un utilisateur ne peut √™tre membre qu'une fois par organisation
  @@unique([profileId, organizationId])
  @@index([profileId])
  @@index([organizationId])
  @@schema("c4dence")
  @@map("memberships")
}

// =============================================================================
// MOD√àLES M√âTHODE C4DENCE
// =============================================================================

/// Objective ‚Äî Objectif Prioritaire (OP)
///
/// Pilier 1 : Focus Strat√©gique
/// Un Objectif est un objectif strat√©gique mesurable avec une √©ch√©ance.
///
/// Format recommand√© : "De X √† Y d'ici [date]"
/// Exemples :
/// - "Augmenter le CA de 2.5M$ √† 3.2M$ d'ici le 31 d√©cembre 2025"
/// - "R√©duire le taux de retour de 8% √† 3% d'ici le 30 juin 2025"
/// - "Atteindre 150 clients actifs (actuellement 89) d'ici le 31 mars 2025"
///
/// Bonnes pratiques :
/// - Maximum 2-3 Objectifs actifs par √©quipe
/// - Doit √™tre mesurable objectivement
/// - L'√©ch√©ance cr√©e l'urgence
model Objective {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Relation organisation ---
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // --- Responsable de l'Objectif (accountability) ---
  // Note: Optionnel pour compatibilit√© avec Objectifs existants, mais requis √† la cr√©ation
  ownerId        String?      @map("owner_id")
  owner          Profile?     @relation("ObjectiveOwner", fields: [ownerId], references: [id])

  // --- D√©finition de l'Objectif ---
  name           String       // Nom court : "Croissance CA 2025"
  description    String?      // Description compl√®te avec contexte

  // --- M√©triques (Indicateur de R√©sultat) ---
  // L'indicateur de r√©sultat = ce qu'on veut atteindre
  // Exemple : Chiffre d'affaires, Taux de satisfaction, Nombre de clients
  startValue     Float        @map("start_value")   // Valeur de d√©part : 2500000
  targetValue    Float        @map("target_value")  // Valeur cible : 3200000
  currentValue   Float        @default(0) @map("current_value") // Valeur actuelle : 2750000
  unit           String       @default("")          // Unit√© : "$", "%", "clients"

  // --- P√©riode ---
  startDate      DateTime     @map("start_date")    // Date de d√©but de l'Objectif
  endDate        DateTime     @map("end_date")      // Date d'√©ch√©ance

  // --- Statut ---
  // IMPORTANT : Ce champ est d√©normalis√© pour performance.
  // Il est recalcul√© par un job CRON ou lors de la mise √† jour des indicateurs.
  // Voir lib/objective-status.ts pour l'algorithme de calcul.
  status         ObjectiveStatus @default(AT_RISK)

  // --- Archivage ---
  isArchived     Boolean      @default(false) @map("is_archived")
  archivedAt     DateTime?    @map("archived_at")

  // --- Relations ---
  leadMeasures   LeadMeasure[]
  blockers       Blocker[]

  @@index([organizationId])
  @@index([ownerId])
  @@index([status])
  @@index([isArchived])
  @@schema("c4dence")
  @@map("objectives")
}

/// LeadMeasure ‚Äî Indicateur Pr√©dictif (IP)
///
/// Pilier 2 : Actions Pr√©dictives
/// Un indicateur pr√©dictif est une action INFLUEN√áABLE et PR√âDICTIVE du r√©sultat.
///
/// Caract√©ristiques :
/// - INFLUEN√áABLE : L'√©quipe peut agir directement dessus
/// - PR√âDICTIVE : Corr√©l√©e avec l'atteinte de l'Objectif
///
/// Exemples pour Objectif "Augmenter CA de 2.5M$ √† 3.2M$" :
/// - "Nombre d'appels de prospection par semaine" (cible: 50)
/// - "Nombre de d√©mos produit par semaine" (cible: 10)
/// - "Nombre de propositions envoy√©es par semaine" (cible: 5)
///
/// Anti-exemples (NON pr√©dictifs) :
/// - "Nombre de ventes" (c'est le r√©sultat, pas l'action)
/// - "CA g√©n√©r√©" (c'est l'Objectif lui-m√™me)
///
/// Bonnes pratiques :
/// - Maximum 2-3 indicateurs pr√©dictifs par Objectif
/// - Doit √™tre mesurable chaque semaine
/// - L'√©quipe doit pouvoir influencer directement
model LeadMeasure {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Relation Objectif ---
  objectiveId String   @map("objective_id")
  objective   Objective @relation(fields: [objectiveId], references: [id], onDelete: Cascade)

  // --- Responsable de l'indicateur (accountability) ---
  assignedToId   String?      @map("assigned_to_id")
  assignedTo     Profile?     @relation("MeasureAssignee", fields: [assignedToId], references: [id])

  // --- D√©finition ---
  name           String       // "Appels de prospection"
  description    String?      // "Appels sortants vers prospects qualifi√©s"
  
  // --- Cible hebdomadaire ---
  // La cible repr√©sente l'objectif HEBDOMADAIRE √† atteindre
  targetPerWeek  Float        @map("target_per_week")  // Cible : 50 appels/semaine
  unit           String       @default("")             // Unit√© : "appels", "d√©mos", "$"

  // --- Ordre d'affichage ---
  sortOrder      Int          @default(0) @map("sort_order")

  // --- Relations ---
  weeklyMeasures WeeklyMeasure[]
  engagements    Engagement[]   @relation("EngagementMeasure")

  @@index([objectiveId])
  @@index([assignedToId])
  @@schema("c4dence")
  @@map("lead_measures")
}

/// WeeklyMeasure ‚Äî Mesure hebdomadaire d'un Indicateur Pr√©dictif
///
/// Pilier 3 : Visibilit√© Continue
/// Chaque semaine, l'√©quipe enregistre sa performance sur chaque indicateur pr√©dictif.
/// 
/// Le num√©ro de semaine suit la norme ISO 8601 :
/// - Semaine 1 = premi√®re semaine contenant un jeudi
/// - Une ann√©e peut avoir 52 ou 53 semaines
/// 
/// Exemple :
/// - LeadMeasure: "Appels de prospection" (cible: 50/semaine)
/// - Semaine 48, 2025 : value = 47 (94% de la cible)
/// - Semaine 49, 2025 : value = 52 (104% de la cible)
model WeeklyMeasure {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Relation LeadMeasure ---
  leadMeasureId String      @map("lead_measure_id")
  leadMeasure   LeadMeasure @relation(fields: [leadMeasureId], references: [id], onDelete: Cascade)

  // --- P√©riode (ISO 8601) ---
  year          Int         // Ann√©e : 2025
  weekNumber    Int         @map("week_number") // Semaine ISO : 1-53

  // --- Valeur enregistr√©e ---
  value         Float       // Valeur r√©elle : 47 (appels effectu√©s)
  
  // --- Notes optionnelles ---
  // Permet de contextualiser une semaine exceptionnelle
  // Ex: "Semaine courte ‚Äî 2 jours f√©ri√©s"
  notes         String?

  // Une seule mesure par semaine par LeadMeasure
  @@unique([leadMeasureId, year, weekNumber])
  @@index([leadMeasureId])
  @@index([year, weekNumber])
  @@schema("c4dence")
  @@map("weekly_measures")
}

/// Invitation ‚Äî Invitation en attente pour rejoindre une organisation
///
/// Permet d'inviter des utilisateurs par email avant qu'ils ne s'inscrivent.
/// L'invitation expire apr√®s 7 jours et contient un token unique.
model Invitation {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")

  // --- Organisation cible ---
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // --- D√©tails invitation ---
  email     String       // Email de la personne invit√©e
  role      MemberRole   @default(MEMBER) // R√¥le qui sera attribu√©
  token     String       @unique // Token unique pour le lien
  expiresAt DateTime     @map("expires_at") // Date d'expiration
  acceptedAt DateTime?   @map("accepted_at") // Null si pas encore accept√©e

  @@index([organizationId])
  @@index([email])
  @@schema("c4dence")
  @@map("invitations")
}

/// Engagement ‚Äî Engagement pris lors d'une r√©union de synchronisation
///
/// Pilier 4 : Rythme de Responsabilit√©
/// Lors de la r√©union hebdomadaire, chaque membre prend 1-2 engagements
/// sp√©cifiques pour la semaine √† venir.
///
/// Format recommand√© : Verbe d'action + Objet + D√©lai
/// Exemples :
/// - "Appeler les 10 prospects chauds de la liste avant mercredi"
/// - "Finaliser la proposition ABC Corp avant vendredi 17h"
/// - "Relancer les 3 devis en attente"
///
/// Bonnes pratiques :
/// - 1-2 engagements par personne par semaine (pas plus!)
/// - Doit √™tre compl√©table en 1 semaine
/// - Li√© aux indicateurs pr√©dictifs (actions qui font avancer le score)
/// 
/// Lors de la r√©union suivante :
/// 1. Chacun rapporte sur ses engagements de la semaine pass√©e
/// 2. Statut : COMPLETED, MISSED, ou explication
/// 3. Nouveaux engagements pour la semaine √† venir
model Engagement {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Qui s'engage ---
  profileId String   @map("profile_id")
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // --- Pour quelle organisation (contexte multi-tenant) ---
  // Note: On pourrait d√©duire via profile->membership->organization,
  // mais on d√©normalise pour simplifier les queries et RLS
  organizationId String @map("organization_id")

  // --- P√©riode ---
  year       Int      // Ann√©e : 2025
  weekNumber Int      @map("week_number") // Semaine ISO : 48

  // --- Contenu de l'engagement ---
  description String  // "Appeler les 10 prospects chauds avant mercredi"

  // --- Lien optionnel vers un Indicateur Pr√©dictif (impact sur le score) ---
  leadMeasureId String?      @map("lead_measure_id")
  leadMeasure   LeadMeasure? @relation("EngagementMeasure", fields: [leadMeasureId], references: [id])

  // --- Suivi ---
  status      EngagementStatus @default(PENDING)
  completedAt DateTime?        @map("completed_at") // Quand marqu√© COMPLETED
  
  // --- Notes de suivi ---
  // Rempli lors de la r√©union suivante pour expliquer le r√©sultat
  // Ex: "8/10 appel√©s, 2 injoignables ‚Äî replanifi√© semaine prochaine"
  followUpNotes String?        @map("follow_up_notes")

  @@index([profileId])
  @@index([organizationId])
  @@index([year, weekNumber])
  @@index([status])
  @@index([leadMeasureId])
  @@schema("c4dence")
  @@map("engagements")
}

/// Blocker ‚Äî Obstacle signal√© lors d'une r√©union de synchronisation
///
/// Pilier 4 : Phase "Clear" de la Session de Synchronisation
/// Les obstacles sont des probl√®mes qui bloquent l'avancement d'un Objectif
/// et qui n√©cessitent une action ou une escalade.
///
/// Exemples :
/// - "Budget marketing gel√© jusqu'√† Q2"
/// - "Ressource cl√© en cong√© maladie"
/// - "D√©pendance sur √©quipe IT bloqu√©e"
model Blocker {
  id           String        @id @default(uuid())
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // --- Quel Objectif est impact√© ---
  objectiveId  String        @map("objective_id")
  objective    Objective     @relation(fields: [objectiveId], references: [id], onDelete: Cascade)

  // --- Qui a signal√© l'obstacle ---
  reportedById String        @map("reported_by_id")
  reportedBy   Profile       @relation("BlockerReporter", fields: [reportedById], references: [id])

  // --- Description de l'obstacle ---
  description  String        // "Budget marketing gel√© jusqu'√† Q2"

  // --- Suivi ---
  status       BlockerStatus @default(OPEN)
  escalatedTo  String?       @map("escalated_to") // Nom/email de la personne
  resolvedAt   DateTime?     @map("resolved_at")
  resolution   String?       // Comment l'obstacle a √©t√© r√©solu

  @@index([objectiveId])
  @@index([reportedById])
  @@index([status])
  @@schema("c4dence")
  @@map("blockers")
}

// =============================================================================
// VUES ET INDEXES ADDITIONNELS
// =============================================================================

// Note : Les vues PostgreSQL et index avanc√©s sont g√©r√©s via des migrations
// SQL manuelles dans prisma/migrations/

// Exemple de vue utile (√† cr√©er via migration SQL) :
//
// CREATE VIEW objective_progress AS
// SELECT
//   o.id as objective_id,
//   o.name,
//   o.start_value,
//   o.target_value,
//   o.current_value,
//   o.start_date,
//   o.end_date,
//   -- Progression en pourcentage
//   CASE
//     WHEN o.target_value = o.start_value THEN 100
//     ELSE ROUND(((o.current_value - o.start_value) / (o.target_value - o.start_value)) * 100, 1)
//   END as progress_percent,
//   -- Jours √©coul√©s vs total
//   EXTRACT(DAY FROM (NOW() - o.start_date)) as days_elapsed,
//   EXTRACT(DAY FROM (o.end_date - o.start_date)) as total_days,
//   -- Progression temporelle en pourcentage
//   ROUND(EXTRACT(DAY FROM (NOW() - o.start_date)) / NULLIF(EXTRACT(DAY FROM (o.end_date - o.start_date)), 0) * 100, 1) as time_progress_percent
// FROM objectives o
// WHERE o.is_archived = false;

// =============================================================================
// NOTES D'IMPL√âMENTATION
// =============================================================================

// 1. ROW LEVEL SECURITY (RLS)
// ---------------------------
// Supabase RLS policies doivent √™tre cr√©√©es pour :
// - profiles : Lecture/√©criture uniquement son propre profil
// - organizations : Via membership
// - memberships : OWNER/ADMIN peuvent g√©rer
// - objectives, lead_measures, weekly_measures : Via organization membership
// - engagements : Lecture org, √©criture soi-m√™me
//
// Voir le fichier SQL s√©par√© : prisma/rls-policies.sql

// 2. TRIGGERS SUPABASE
// --------------------
// - on_auth_user_created : Cr√©e Profile quand user s'inscrit
// - on_profile_updated : Sync avec auth.users si n√©cessaire
//
// Voir : supabase/migrations/

// 3. CALCUL DU STATUT OBJECTIF
// ----------------------------
// Le statut est recalcul√© :
// - √Ä chaque mise √† jour de WeeklyMeasure (via Server Action)
// - Via CRON job quotidien (pour rattraper les edge cases)
//
// Algorithme dans : lib/objective-status.ts

// 4. SOFT DELETE
// --------------
// Les Objectifs utilisent isArchived plut√¥t que suppression.
// Les autres entit√©s utilisent CASCADE via foreign keys.
// =============================================================================
// MOD√àLES C4DENCE v3.1 (PLANCHER + ORCHESTRATION)
// =============================================================================

/// Task ‚Äî T√¢che op√©rationnelle du Plancher
///
/// Niveau Op√©rationnel : Gestion du tourbillon quotidien
/// Kanban √† 4 colonnes : √Ä TRIER -> √Ä FAIRE -> EN COURS -> FAIT
model Task {
  id             String       @id @default(uuid())
  title          String
  description    String?
  
  // --- Triage (Matrice Urgence x Impact) ---
  urgency        Urgency?     // HIGH, LOW
  businessImpact BusinessImpact? // HIGH, LOW
  category       TaskCategory? // AUTO-CALCUL√â: IMMEDIATE, PLAN, DELEGATE, BACKLOG
  
  // --- Flux Kanban ---
  status         TaskStatus   @default(TO_TRIAGE)
  assignedToId   String?      @map("assigned_to_id")
  assignedTo     Profile?     @relation(fields: [assignedToId], references: [id])
  
  // --- M√©tadonn√©es ---
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now()) @map("created_at")
  dueDate        DateTime?    @map("due_date")
  completedAt    DateTime?    @map("completed_at")
  
  @@index([organizationId])
  @@index([assignedToId])
  @@index([status])
  @@schema("c4dence")
  @@map("tasks")
}

enum Urgency {
  HIGH  // Dans les prochaines heures
  LOW   // Peut attendre quelques jours
  
  @@schema("c4dence")
}

enum BusinessImpact {
  HIGH  // Bloque revenus, clients, employ√©s
  LOW   // Inconv√©nient, entreprise continue
  
  @@schema("c4dence")
}

enum TaskCategory {
  IMMEDIATE  // Faire maintenant (Haute urgence √ó Fort impact)
  PLAN       // Planifier cette semaine (Basse urgence √ó Fort impact)
  DELEGATE   // D√©l√©guer ou refuser (Haute urgence √ó Faible impact)
  BACKLOG    // Si temps disponible (Basse urgence √ó Faible impact)
  
  @@schema("c4dence")
}

enum TaskStatus {
  TO_TRIAGE   // √Ä trier
  TODO        // √Ä faire
  IN_PROGRESS // En cours (max 3 par personne)
  DONE        // Termin√©
  
  @@schema("c4dence")
}

/// TimeAllocation ‚Äî Allocation temps hebdomadaire
///
/// Permet de tracker le ratio Plancher / Piliers.
/// R√®gle d'or : Minimum 10% sur les Piliers (strat√©gique).
model TimeAllocation {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  weekStartDate  DateTime     @map("week_start_date") // Lundi de la semaine (ISO week)
  
  // --- Heures par niveau ---
  floorHours     Float        @map("floor_hours")   // Heures Plancher (op√©rationnel)
  pillarsHours   Float        @map("pillars_hours") // Heures Piliers (strat√©gique)
  
  // --- Calculs automatiques (stock√©s pour historique) ---
  totalHours     Float        @map("total_hours")   // = floorHours + pillarsHours
  pillarsPercent Float        @map("pillars_percent") // = (pillarsHours / totalHours) * 100
  
  // --- Validation ---
  meetsMinimum   Boolean      @map("meets_minimum") // = pillarsPercent >= 10
  
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  
  @@unique([organizationId, weekStartDate])
  @@index([organizationId])
  @@schema("c4dence")
  @@map("time_allocations")
}

/// CadenceMode ‚Äî Mode de cadence choisi par l'organisation
///
/// D√©finit le rythme des r√©unions (Orchestration).
model CadenceMode {
  id             String       @id @default(uuid())
  organizationId String       @unique @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  mode           Mode         @default(MODE_A)
  
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  
  @@schema("c4dence")
  @@map("cadence_modes")
}

enum Mode {
  MODE_A  // R√©union unifi√©e (45 min/semaine) - Petites √©quipes 1-3
  MODE_B  // R√©unions s√©par√©es (standard) - √âquipes 4-10
  MODE_C  // Daily + Hebdo (intensif) - Grandes √©quipes 10+ ou crise
  
  @@schema("c4dence")
}
